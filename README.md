# Webhook Example

This repo includes an example about how to implement an admission
webhook using the library in the `sigs.k8s.io/controller-runtime`.
This can be an prototype of how this can be integrated with `kubebuilder`

## Repo structure

This project is mostly generated by kubebuilder with some manually changes to setup the webhook.

`cmd/manager` contains some example code of how to implement an admission
webhook using the library in the `controller-runtime` repo.

`manifests` contains some k8s resources for deploying the webhook
in your cluster. You can run `kubectl apply -f mainifests/` to
deploy them.

`Dockerfile` knows how to build an docker image for the webhook server.

`Makefile` can let you build and push your image; deploy the webhook.
Set the `IMG` environment variable before building or pushing your image.

What you will care most is how to write webhook handlers in `pkg/webhook/` and
how to wire thing in the manager in `cmd/manager/main.go`.

## Workflow

- make docker-build
- make docker-push
- make install
- make deploy

After completing all of the above steps, you webhook server should be ready to serve.
You can try the following actions:

- create a deployment `kubectl create deployment nginx --image=nginx`.
You should be able to see it adds an annotation.
- create a instance of `firstmate` CR: `kubectl apply -f config/samples/crew_v1alpha1_firstmate.yaml`
You should be able to see it changes the value of field `.spec.foo` to `bar`.
- create a instance of `firstmate` CR: `kubectl apply -f config/samples/creatures_v1alpha1_kraken.yaml`
You should be able to see it adds an annotation.

If you want to clean it up, you can do `make clean`.

### Notes
`make install` will register the CRDs in your cluster.
This is a required step to have the webhook server working.
Otherwise, the RESTMapper will complain.

You will need to register your CRD in the scheme.
Your CRD type definition can live in this project or outside of this project.
